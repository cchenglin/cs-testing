-- å»ºç«‹è³‡æ–™åº«
CREATE DATABASE IF NOT EXISTS school_system;
USE school_system;

-- å»ºç«‹å­¸ç”Ÿå¸³è™Ÿè¡¨æ ¼
CREATE TABLE IF NOT EXISTS students (
    student_id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(50) NOT NULL,
    password VARCHAR(100) NOT NULL,
    grade VARCHAR(10),
    classroom VARCHAR(10),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å»ºç«‹è€å¸«å¸³è™Ÿè¡¨æ ¼
CREATE TABLE IF NOT EXISTS teachers (
    teacher_id INT AUTO_INCREMENT PRIMARY KEY,
    username VARCHAR(50) NOT NULL UNIQUE,
    name VARCHAR(50),
    password VARCHAR(100) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
-- æ’å…¥ 5 ä½è€å¸«çš„é è¨­å¸³è™Ÿå¯†ç¢¼
INSERT INTO teachers (username, password)
VALUES
('teacher1', 'password1'),
('teacher2', 'password2'),
('teacher3', 'password3'),
('teacher4', 'password4'),
('teacher5', 'password5');

-- å»ºç«‹è£ç½®è¡¨æ ¼
CREATE TABLE IF NOT EXISTS devices (
  id INT AUTO_INCREMENT PRIMARY KEY,
  student_id INT NOT NULL,
  device_name VARCHAR(255),
  device_pubkey_base64 TEXT,      -- å­˜ Secure Enclave åŒ¯å‡ºçš„ public key (raw, base64)
  attestation_json JSON NULL,     -- å¯æ”¾ AppAttest / WebAuthn attestation if used
  bind_ssid VARCHAR(255),
  bind_ip VARCHAR(64),
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  last_seen TIMESTAMP NULL,
  FOREIGN KEY (student_id) REFERENCES students(student_id)
);

-- å»ºç«‹ Nonce è¡¨æ ¼
CREATE TABLE IF NOT EXISTS nonces (
  id INT AUTO_INCREMENT PRIMARY KEY,
  student_id INT,
  class_id INT,
  nonce VARCHAR(128),
  issued_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP,
  used BOOLEAN DEFAULT FALSE
);

-- å»ºç«‹ç°½åˆ°ç´€éŒ„è¡¨æ ¼
CREATE TABLE IF NOT EXISTS attendance (
  id INT AUTO_INCREMENT PRIMARY KEY,
  student_id INT NOT NULL,
  class_id INT NOT NULL,
  timestamp DATETIME,
  ipfs_cid VARCHAR(255),
  data_hash VARCHAR(128),
  onchain_txhash VARCHAR(128),
  verified_by_device BOOLEAN,
  verification_meta JSON,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- âœ… æ¸¬è©¦æŸ¥è©¢ (æª¢æŸ¥è¡¨æ ¼å…§å®¹)
SELECT 'ğŸ“˜ TEACHERS TABLE' AS section;
SELECT * FROM teachers;

SELECT 'ğŸ“— STUDENTS TABLE' AS section;
SELECT * FROM students;

SELECT 'ğŸ“± DEVICES TABLE' AS section;
SELECT * FROM devices;

SELECT 'ğŸ§© NONCES TABLE' AS section;
SELECT * FROM nonces;

SELECT 'ğŸ•’ ATTENDANCE TABLE' AS section;
SELECT * FROM attendance;

-- èª²ç¨‹è¡¨ï¼ˆè€å¸«å»ºç«‹èª²ç¨‹ï¼‰
CREATE TABLE IF NOT EXISTS courses (
  course_id INT AUTO_INCREMENT PRIMARY KEY,
  teacher_id INT NOT NULL,
  course_name VARCHAR(100) NOT NULL,
  course_code VARCHAR(10) NOT NULL UNIQUE,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- å­¸ç”Ÿé¸èª²è¡¨ï¼ˆå­¸ç”ŸåŠ å…¥èª²ç¨‹ï¼‰
CREATE TABLE IF NOT EXISTS course_students (
  id INT AUTO_INCREMENT PRIMARY KEY,
  course_id INT NOT NULL,
  student_id INT NOT NULL,
  joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- é»åç´€éŒ„è¡¨ï¼ˆè¨˜éŒ„å­¸ç”Ÿæ˜¯å¦ç°½åˆ°ï¼‰
CREATE TABLE IF NOT EXISTS attendance (
  id INT AUTO_INCREMENT PRIMARY KEY,
  course_id INT NOT NULL,
  student_id INT NOT NULL,
  date DATE NOT NULL,
  time TIME NOT NULL,
  status ENUM('present', 'absent') DEFAULT 'absent'
);

CREATE TABLE attendance_sessions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  course_id INT NOT NULL,
  start_time DATETIME NOT NULL,
  end_time DATETIME NOT NULL,
  is_active BOOLEAN DEFAULT TRUE,
  FOREIGN KEY (course_id) REFERENCES courses(id)
);

-- A. å»ºç«‹é»åå ´æ¬¡è¡¨ï¼ˆæ¯æ¬¡è€å¸«æŒ‰ã€Œé–‹å§‹é»åã€å°±æ–°å¢ä¸€ç­†ï¼‰
CREATE TABLE IF NOT EXISTS attendance_sessions (
  id INT AUTO_INCREMENT PRIMARY KEY,
  course_id INT NOT NULL,
  started_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  duration INT NULL,                 -- ç§’æ•¸ï¼ˆå¯ç‚º NULLï¼‰
  is_open TINYINT(1) NOT NULL DEFAULT 1
);

-- B. åœ¨èª²ç¨‹è¡¨åŠ ä¸Šç›®å‰é€²è¡Œä¸­çš„å ´æ¬¡ id
ALTER TABLE courses
  ADD COLUMN current_session_id INT NULL AFTER is_attendance_open;

-- C. åœ¨ç°½åˆ°è¡¨åŠ ä¸Š session_idï¼ˆç”¨ä¾†åˆ¤æ–·ã€ŒåŒä¸€å ´ã€æ˜¯å¦å·²ç°½åˆ°éï¼‰
ALTER TABLE attendance
  ADD COLUMN session_id INT NULL AFTER student_id;
